<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport">
    <title>Home</title>
    <style>

        *::-webkit-scrollbar {
            display: none;
        }

        .entry {
            display: flex;
            border-bottom: 1px solid var(--border-lighter);
            border-radius: 0;
            height: 50px;
            justify-content: space-between;
            align-items: center;
            margin: 5px;
            font-size: 18px;
            transition: 200ms;
        }

        #go {
            background: none;
            height: 40px;
            width: 50px;
            border-radius: 4px;
            border: 1px solid var(--border);
            transition: 200ms;
        }

        #go:hover {
            cursor: pointer;
            box-shadow: 0 0 4px 2px var(--header-color);
            color: var(--text-color);
        }

        /* The switch - the box around the slider */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
            border-radius: 5000px;
            transition: 300ms;
        }

        /* Hide default HTML checkbox */
        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
            transition: 300ms;
        }

        /* The slider */
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #dc1515;
            -webkit-transition: .4s;
            transition: .3s;
            border-radius: 5000px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: var(--background);
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 5000px;
        }

        input:checked + .slider {
            background-color: #38b028;
        }

        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }

        #error {
            transition: 400ms;
            color: red;
        }

        /* The alert message box */
        #alert {
            padding: 20px;
            background-color: var(--bg-accent);
            color: var(--text-color);
            position: absolute;
            right: 20px;
            transition: opacity 0.2s;
            border-radius: 10px;
        }
        .closebtn {
            margin-left: 15px;
            color: white;
            font-weight: bold;
            float: right;
            font-size: 22px;
            line-height: 20px;
            cursor: pointer;
            transition: 0.3s;
        }

        /* When moving the mouse over the close button */
        .closebtn:hover {
            color: var(--text-light);
        }
    </style>
</head>
<body>
    <div id="alert"></div>
    <div>
        <div style="float: right; padding-right: 10px">
            <label for="search"></label>
            <input placeholder="search..." oninput="search()" id="search" autocomplete="off">
            (<span id="number-of"></span>/<span id="number-of-total"></span>)
        </div>
    </div>
    <p id="error"></p>
    <div style="height: 50px; border: none; margin: 10px 0 5px 20px;">
        <span style="font-size: 18px">
            to/
        </span>
        <label for="from"></label>
        <input id="from" autocomplete="off">
        <span style="font-size: 18px">
            redirects to
        </span>
        <label for="to"></label>
        <input id="to" autocomplete="off">
        <button id="go" style="font-size: 18px">Add</button>
    </div>
    <div id="entries"></div>
</body>
</html>

<script>

    const ERROR = document.getElementById('error');
    const entries = document.getElementById('entries');

    const SEARCH = document.getElementById('search');

    const ALERT_BANNER = document.getElementById('alert');

    ALERT_BANNER.style.display = 'none';

    function alertBanner(msg) {
        ALERT_BANNER.style.display = 'flex';
        ALERT_BANNER.innerHTML = `
            ${msg}
            <span class="closebtn" onclick="this.parentElement.style.display='none';">&times;</span>
        `;
        setTimeout(() => {
            ALERT_BANNER.style.display = "none";
        }, 3000);
    }

    // src: https://stackoverflow.com/questions/400212/how-do-i-copy-to-the-clipboard-in-javascript
    function fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;

        // Avoid scrolling to bottom
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";

        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();

        try {
            var successful = document.execCommand('copy');
            alertBanner(successful ? 'Copied Successfully!' : 'Copy failed');
        } catch (err) {
            console.error('Fallback: Oops, unable to copy', err);
        }

        document.body.removeChild(textArea);
    }
    function copy(text) {
        if (!navigator.clipboard) {
            fallbackCopyTextToClipboard(text);
            return;
        }
        navigator.clipboard.writeText(text).then(function() {
            alertBanner('Copied Successfully!');
        }, (err) => {
            alertBanner('Copy failed: ' + err);
        });
    }

    function search () {
        sessionStorage.setItem('redirects-search', SEARCH.value);
        render(SEARCH.value, true);
    }

    async function handleServerResponse (res) {
        res = await res.text();
        res = JSON.parse(res);
        if (!res.ok) {
            ERROR.innerHTML = res.error || 'An error has occurred';
            return;
        }
        render();
    }

    function deleteOfName (name) {
        if (!confirm(`Are you sure you want to delete '${name}'`)) {
            return;
        }
        fetch('http://coppin/delete-redirect', {
            method: 'POST',
            body: JSON.stringify({
                from: name
            })
        }).then(handleServerResponse);
    }

    function toggleOfName (name, value) {
        console.log(JSON.stringify({
            from: name,
            value
        }));
        fetch('http://coppin/toggle-redirect', {
            method: 'POST',
            body: JSON.stringify({
                from: name,
                value
            })
        }).then(handleServerResponse);
    }

    let CACHE;

    async function loadData (search, useCache) {
        if (!useCache || !CACHE) {
            const data = await fetch(
                'http://192.168.86.54/redirects.csv?cachebust=' + (Math.random() * 100000).toFixed(0));
            CACHE = parseCSV(await data.text());
            document.getElementById('number-of-total').innerHTML = CACHE.length;
        }

        if (search) {
            const res = CACHE.filter(r =>
                new RegExp(search.toLowerCase()).test(r[0].toLowerCase()) ||
                new RegExp(search.toLowerCase()).test(r[1].toLowerCase())
            );
            document.getElementById('number-of').innerHTML = res.length;
            return res;
        }

        document.getElementById('number-of').innerHTML = CACHE.length;

        return CACHE;
    }

    async function render (search=SEARCH.value, useCache=false) {

        const rows = await loadData(search, useCache);

        // reset after data is loaded
        entries.innerHTML = '';
        ERROR.innerHTML = '';
        document.getElementById('from').value = '';
        document.getElementById('to').value = '';

        for (let row of rows) {
            let url = row[1];
            if (row[1].length > 70) {
                url = row[1].substr(0, 70) + '...';
            }
            entries.innerHTML += `
                <div class="entry">
                    <a href="http://coppin/${row[0]}" style="margin: 4px" target="_blank">
                        ${row[0]}
                    </a>
                    <a href="${row[1]}" style="margin: 4px" target="_blank">${url}</a>
                    <div style="display: flex; justify-content: center; align-items: center">
                        <label class="switch">
                            <input
                                type="checkbox" ${row[2] === '1' ? 'checked' : ''}
                                onclick="toggleOfName('${row[0]}', Number(!${row[2]}).toString())"
                                name="toggle ${row[0]}"
                            >
                            <span class="slider"></span>
                        </label>
                        <button onclick="deleteOfName('${row[0]}')" class="icon" name="delete ${row[0]}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000" class="delete-bin">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M16 9v10H8V9h8m-1.5-6h-5l-1 1H5v2h14V4h-3.5l-1-1zM18 7H6v12c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7z"/>
                            </svg>
                        </button>
                        <button onclick="copy('http://to/${row[0]}')" class="icon" name="copy ${row[0]}">
                            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#000000" class="delete-bin">
                                <path d="M0 0h24v24H0V0z" fill="none"/>
                                <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                            </svg>
                        </button>
                        <span style="min-width: 25px">
                            ${row[3]}
                        </span>
                    </div>
                </div>
            `;
        }
    }

    document.getElementById('go').addEventListener('click', () => {
        const from = document.getElementById('from').value;
        const to = document.getElementById('to').value;

        if (!/^(ftp|http|https):\/\/[^ "]+$/.test(to)) {
            ERROR.innerHTML = 'Not a valid URl, please try again. Make sure to include https://';
            return;
        }

        if (!/^[a-zA-Z1-9_-]+$/.test(from)) {
            ERROR.innerHTML = 'Not a valid name, please try again. Make sure it is only letters, numbers, _ and -';
            return;
        }

        fetch('http://192.168.86.54/add-redirect', {
            method: 'POST',
            body: JSON.stringify({ from, to })
        }).then(handleServerResponse);
    });

    let storedSearchValue = sessionStorage.getItem('redirects-search');
    if (storedSearchValue) {
        SEARCH.value = storedSearchValue;
    }

    render();
</script>
